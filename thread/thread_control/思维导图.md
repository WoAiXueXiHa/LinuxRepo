# Linux 多线程核心体系

## 1. 核心概念
- **形象比喻**
  - 进程：独居（独占资源）
  - 线程：合租（共享地址空间 / 独享房间-栈）
- **内核本质**
  - Linux无真正线程 -> 复用 task_struct
  - 本质：轻量级进程 (LWP)
  - CPU调度：不区分进程/线程，只看执行流
- **定义区分**
  - 进程：资源分配的基本单位
  - 线程：CPU调度的基本单位

## 2. 线程控制 (API)
- **创建 (Create)**
  - `pthread_create`
  - 关键：arg参数必须指向堆/全局（防止栈销毁）
  - ID对比：`pthread_self` (库地址) vs LWP (内核调度ID)
- **终止 (Exit)**
  - `return`：自然死亡（最推荐）
  - `pthread_exit`：自杀（只结束当前线程）
  - `pthread_cancel`：他杀（需系统调用作为取消点）
  - ⚠️ 致命陷阱：线程调 `exit()` 会导致整个进程退出
- **等待 (Join)**
  - `pthread_join`
  - 目的：阻塞等待 + 回收PCB + 获取返回值
  - 难点：使用 `void**` (二级指针) 接收返回值
- **分离 (Detach)**
  - `pthread_detach`
  - 场景：高并发服务端，不需要返回值
  - 效果：OS自动回收资源，不可再Join

## 3. 源码深度理解
- **clone 系统调用**
  - `CLONE_VM`：共享 mm_struct -> 共享页表 -> TLB不刷新 -> 切换快
  - `CLONE_FILES`：共享文件描述符表
- **ID 深度辨析**
  - `pid` (内核源码域)：对应 LWP ID (调度用)
  - `tgid` (内核源码域)：对应 进程 PID (用户看)
- **硬件与内存**
  - **栈 (Stack)**：mmap申请，物理上共享，逻辑上独享
  - **寄存器**：硬件绝对独享 (上下文切换的核心内容)

## 4. 资源清单
- **共享资源 (省资源)**
  - 虚拟地址空间 (代码段 / 数据段 / 堆)
  - 文件描述符表 (fd)
  - 信号处理函数
  - 用户ID / 工作目录
- **独享资源 (保独立)**
  - 线程ID (LWP)
  - **栈 (Stack)** (局部变量)
  - **寄存器** (PC指针 / SP栈指针)
  - errno (TLS变量)
  - 信号屏蔽字